# functions generated by PoprC
FUNCTIONS = tests.fibl tests.collatz algorithm.gcd algorithm.sum
COMMON = ../vlgen/primitives.v ../vlgen/define.v

# use eval to get file names for each function
FUNCTION_SRCS = $(foreach target, $(FUNCTIONS), $(shell ../eval -ident $(target)).v)

# set FUNCTION for each target in FUNCTION_SRCS
$(foreach target, $(FUNCTIONS), $(eval $(shell ../eval -ident $(target)).v:FUNCTION=$(target)))

.PHONY: all
all: $(patsubst %_tb.v, %_tb.vcd, $(wildcard *_tb.v)) $(patsubst %, proc/%, $(wildcard *_swbut.v)) 

print-%:
	@echo $* = $($*)

%_tb.vcd: %_tb.vvp
	vvp $<

proc/%.v: %.v
	@mkdir -p proc
	vppreproc -I../vlgen $< > $@

.PRECIOUS: proc/%.v

stream_tb.vvp: proc/stream_tb.v $(COMMON)
	iverilog -o $@ -I../vlgen $<

%_tb.vvp: proc/%_tb.v %.v $(COMMON)
	iverilog -o $@ -I../vlgen $<

$(FUNCTION_SRCS): ../lib.ppr ../tests.ppr ../eval
	(cd ..; ./eval -lo lib.ppr tests.ppr -cv $(FUNCTION)) > $@

../eval:
	make -C ..

.PHONY: clean
clean:
	rm -f *.vvp *.vcd $(FUNCTION_SRCS)
	rm -rf proc
