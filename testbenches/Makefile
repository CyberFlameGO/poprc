# functions generated by PoprC
FUNCTIONS = \
  tests.fibl \
  tests.collatz \
  algorithm.gcd \
  algorithm.sum \
  list.reverse \
  tests.repeat_int \
  tests.dup_map \
  tests.map_add1 \
  tests.fact \
  tests.fib
COMMON = ../vlgen/primitives.v ../vlgen/define.v

BUILD = build
INCLUDE = -I../vlgen -I$(BUILD)/gen

.PHONY: all
all: test $(patsubst %, $(BUILD)/preprocessed/%, $(wildcard *_swbut.v))

.PHONY: sim
sim: $(patsubst %_tb.v, $(BUILD)/sim/%_tb.fst, $(wildcard *_tb.v))
sim: $(patsubst %_tb.v, $(BUILD)/sim/%_tb.log, $(wildcard *_tb.v))

.PHONY: test
test: sim
	diff -U 3 -r -x '*.fst' -x '*~' verified $(BUILD)/sim

.PHONY: verify
verify: sim
	@mkdir -p verified
	cp $(BUILD)/sim/*.log verified/

print-%:
	@echo $* = $($*)

# keep intermediate files
.SECONDARY:

$(BUILD)/sim/%_tb.fst $(BUILD)/sim/%_tb.log: $(BUILD)/vvp/%_tb.vvp
	@mkdir -p $(BUILD)/sim
	cd $(BUILD)/sim && vvp -l$*_tb.log $(abspath $<) -fst

# add generated files as prerequisites for *_tb.v and *_swbut.v
$(foreach suf, tb swbut swbut_tb, \
  $(foreach target, $(wildcard *_$(suf).v), \
    $(eval $(BUILD)/preprocessed/$(target): $(patsubst %_$(suf).v, $(BUILD)/gen/%.v, $(target)))))
$(BUILD)/preprocessed/%.v: %.v $(COMMON)
	@mkdir -p $(dir $@)
	iverilog -o - -E $(INCLUDE) -Ddumpfile="\"$*.fst\"" $< | sed '/^\s*$$/d' > $@

$(BUILD)/vvp/%_tb.vvp: $(BUILD)/preprocessed/%_tb.v
	@mkdir -p $(dir $@)
	iverilog -o $@ $(INCLUDE) $<

$(BUILD)/gen/%.v: ../lib.ppr ../tests.ppr ../eval
        # set FUNCTION for each target in FUNCTION_SRCS
	$(foreach target, $(FUNCTIONS), \
	  $(eval $(BUILD)/gen/$(shell ../eval -ident $(target)).v:FUNCTION=$(target)))
	@mkdir -p $(dir $@)
	@if [ "$(FUNCTION)" ]; then \
	  echo "generating $(FUNCTION)"; \
          (cd ..; ./eval -lo lib.ppr tests.ppr -cv $(FUNCTION)) > $@; \
        fi

../eval:
	make -C ..

.PHONY: clean
clean:
	rm -rf $(BUILD)
